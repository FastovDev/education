Библиотека для работы в режиме реального времени. Например, чаты, социальные сети, игровые приложения, мониторинг данных и т.д.

**SignalR** — это библиотека от Microsoft, предназначенная для добавления в веб-приложения функциональности в реальном времени. С её помощью сервер может мгновенно отправлять обновления всем подключённым клиентам без необходимости того, чтобы клиенты постоянно опрашивали сервер (polling).

Работа библиотеки строится на WebSockets, Server-Sent Events, Long Polling, Forever Frame.  Приложение по умолчанию будет пытаться использовать эти технологии в порядки написания. Если не удается построить приложение на WebSockets, то будет осуществлена попытка повторить запрос с помощью SSE, иначе дойдет дело до Long Polling. 

## Основные возможности SignalR

- **Реальное время:**  
    Обеспечивает двунаправленное взаимодействие между клиентом и сервером в режиме реального времени. Это особенно полезно для чатов, уведомлений, онлайн-игр и других интерактивных приложений.
    
- **Автоматический выбор транспорта:**  
    SignalR автоматически определяет и использует наиболее подходящий транспорт для связи: WebSockets, Server-Sent Events (SSE) или Long Polling, в зависимости от возможностей клиента и сервера.
    
- **Простота интеграции:**  
    Легко интегрируется в ASP.NET (Core) проекты с минимальными настройками.

Для работы SignalR в серверной части необходимо подключить:

```C#
using SignalRApp;
builder.Services.AddSignalR();
app.MapHub<ChatHub>("/chat");
```

Подключение сервисов в приложение представляет собой следующую реализацию
`ISignalRServerBuilder AddSignalR(Action<HubOptions> configure);`

Перегрузка метода позволяет сконфигурировать следующие свойства:

- ClientTimeoutInterval. Определяет время, в течение которого клиент должен отправить серверу сообщение. Если в течение данного времени никаких сообщений от клиента на сервер не пришло, то сервер закрывает соединение. (30 секунд дефолт)

- HandshakeTimeout. После подключения к серверу клиент должен отправить серверу в качестве самого первого сообщения специальное сообщение - HandshakeRequest. Это свойство устанавливает допустимое время таймаута, которое может пройти до получения от клиента первого сообщения об установки соединения. Если в течение этого периода клиент не отправит первое сообщение, то подключение закрывается. (15 секунд дефолт)
   
- KeepAliveInterval: если в течение этого периода сервер не отправит никаких сообщений, то автоматически отправляется ping-сообщение для поддержания подключения открытым. При изменении этого свойства Microsoft рекомендует изменить на стороне клиента параметр serverTimeoutInMilliseconds (клиент javascript)/ ServerTimeout(клиент .NET), которое рекомендуется устанавливать в два раза больше, чем KeepAliveInterval. (15 сек)

- SupportedProtocols определяет поддерживаемые протоколы. По умолчанию поддерживаются все протоколы.

- EnableDetailedErrors при значении true возвращает клиенту детальное описание возникшей ошибки (при ее возникновении). Поскольку подобные сообщения могут содержать критически важную для безопасности информацию, то по умолчанию имеет значение false.

- StreamBufferCapacity определяет максимальный размер буфера для входящего потока клиента. По умолчанию равно 10.

- MaximumReceiveMessageSize определяет максимальный размер для входящего сообщения. По умолчанию - 32 кб

- MaximumParallelInvocationsPerClient определяет максимальное количество методов хаба, которые клиент может вызвать параллельно. По умолчанию равно 1.

## Использование SignalR в проекте

### 1. Создание хаба (Hub)

Хаб — это центральная точка, через которую происходит общение между сервером и клиентами. Он наследуется от класса `Hub`.

```C#
using Microsoft.AspNetCore.SignalR;

public class ChatHub : Hub
{
    // Метод, который может вызываться клиентами для отправки сообщений
    public async Task SendMessage(string user, string message)
    {
        // Отправка сообщения всем подключенным клиентам
        await Clients.All.SendAsync("ReceiveMessage", user, message);
    }
}

```

### 2. Настройка SignalR в ASP.NET Core

В файле `Program.cs` (или `Startup.cs`, в зависимости от версии) необходимо зарегистрировать SignalR и настроить маршрут для хаба.

**Пример для ASP.NET Core 6 и новее:**

```C#
var builder = WebApplication.CreateBuilder(args);

// Регистрация SignalR
builder.Services.AddSignalR();

var app = builder.Build();

app.UseRouting();

app.UseEndpoints(endpoints =>
{
    // Регистрируем хаб по адресу /chathub
    endpoints.MapHub<ChatHub>("/chathub");
});

app.Run();

```

### 3. Клиентская сторона

На клиенте можно использовать JavaScript-библиотеку SignalR. Ниже приведён пример, как подключиться к хабу и взаимодействовать с ним.

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
    <!-- Подключаем библиотеку SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
</head>
<body>
    <div>
        <input type="text" id="userInput" placeholder="Ваше имя" />
        <input type="text" id="messageInput" placeholder="Сообщение" />
        <button id="sendButton">Отправить</button>
    </div>
    <ul id="messagesList"></ul>

    <script>
        // Создаем подключение к хабу по адресу /chathub
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        // Определяем обработчик получения сообщения
        connection.on("ReceiveMessage", function(user, message) {
            const li = document.createElement("li");
            li.textContent = `${user}: ${message}`;
            document.getElementById("messagesList").appendChild(li);
        });

        // Запускаем подключение
        connection.start().catch(err => console.error(err.toString()));

        // Обработка клика по кнопке "Отправить"
        document.getElementById("sendButton").addEventListener("click", function(event) {
            const user = document.getElementById("userInput").value;
            const message = document.getElementById("messageInput").value;
            // Вызываем метод хаба SendMessage на сервере
            connection.invoke("SendMessage", user, message).catch(err => console.error(err.toString()));
            event.preventDefault();
        });
    </script>
</body>
</html>
```
---

## Преимущества и сценарии использования

- **Чаты и системы мгновенных уведомлений:**  
    Позволяет мгновенно оповещать пользователей о новых сообщениях или событиях.
    
- **Онлайн-игры и коллаборативные приложения:**  
    Обеспечивает синхронизацию состояний между клиентами в реальном времени.
    
- **Мониторинг и обновление данных:**  
    Позволяет серверу отправлять обновления данных, как только они становятся доступны.
    
- **Работа с большими объёмами пользователей:**  
    Использование подходящих транспортов позволяет масштабировать приложение под высокую нагрузку.
    

---

## Заключение

SignalR — мощный инструмент для реализации функционала реального времени в веб-приложениях. Он упрощает процесс организации двусторонней коммуникации между клиентами и сервером, автоматически подбирая оптимальный транспорт для передачи данных. Это делает его отличным выбором для создания чатов, систем уведомлений, онлайн-игр и других интерактивных сервисов.