NGINX умеет распределять не только http-запросы. Его можно использовать для балансировки запросов на 4-м уровне модели OSI (TCP и UDP), например, подключения к СУБД, DNS и так далее — по сути, любой сетевой запрос может быть обработан и распределен с помощью данного программного продукта.

### **Основы**

NGINX автоматически читает все конфигурационные файлы в каталоге conf.d.
Можно создать группу серверов, между которыми будет осуществляться балансировка

`vi /etc/nginx/conf.d/upstreams.conf`

Содержимое файла:

`upstream my_backend {`  
    `server 192.168.10.10;`  
    `server 192.168.10.11;`  
    `server 192.168.10.12;`  
`}`

Предполагается в данном примере, что на указанным адресах есть сервера во внутренней сети, где расположен nginx. 

Укажем в настройках nginx проксирование по созданной нами конфигурации:

`server {`  
    `...`  
    `location / {`  
        `proxy_pass http://my_backend;`  
    `}`  
    `...`  
`}`

Указанная настройка будет переводить абсолютно все запросы на указанные в конфигурационном файле веб-сервера. По умолчанию все сервера имеют равный приоритет равный единице, но с помощью ключевого слова weight мы можем указать частоту обращения на конкретный веб-сервер. 
Рассмотрим следующую конфигурацию: 

`upstream my_backend {`  
    `server 192.168.10.10 weight=100;`  
    `server 192.168.10.11 weight=10;`  
    `server 192.168.10.12;`  
    `server 192.168.10.13 backup;`  
    `server 192.168.10.14 down;`
`}`

Данная конфигурация определяет частоту запросов на веб-сервера.
Обращение к серверу 192.168.10.10 будет происходить 100 раз на каждое обращение к 12 адресу и каждые 10 раз на одно обращение к 11. 
То есть из 111 запросов - 100 будет обработано 10-м сервером, 10 - 11-м, и 1 обращение упадет на 12 сервер. 

Кроме того есть ключевые слова backup - так обозначается сервер, который будет использоваться в случае, если все другие сервера окажутся недоступными, и down - так обозначается сервер, которые считается недоступным на постоянной основе, например, если данный сервер находится в обслуживании или на нем ведутся другие работы, которые приостанавливают его работу. 

Алгоритмы балансировки:
1. Round Robin (по умолчанию)
Запросы распределяются по серверам по очереди. Этот метод равномерно распределяет нагрузку между всеми серверами.
Пример конфигурации уже приведен выше.
2. Least Connections
Запрос направляется на сервер с наименьшим количеством активных соединений.
Используется для того, чтобы разгружать серверы, на которых в данный момент больше всего активных запросов.
Пример настройки Least Connections:

upstream backend_servers {
    least_conn;
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}
3. IP Hash
Этот метод привязывает клиента к конкретному серверу на основе его IP-адреса. Это полезно, если важно, чтобы запросы от одного и того же клиента всегда шли на один и тот же сервер (например, для сохранения сессий).
Пример конфигурации с IP Hash:

upstream backend_servers {
    ip_hash;
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;
}
Дополнительные параметры:
Вес сервера (weight): Можно указать "вес" для каждого сервера, чтобы более мощные сервера получали больше запросов.
Пример конфигурации с весом серверов:

upstream backend_servers {
    server backend1.example.com weight=3;
    server backend2.example.com weight=1;
    server backend3.example.com weight=2;
}
В этом примере сервер backend1 будет получать 3 запроса на каждые 1 запрос к серверу backend2.

Настройка проверки работоспособности (health checks):
Nginx может использовать пассивную проверку доступности серверов: если сервер не отвечает на запросы, он временно исключается из списка активных.

Пример настройки:

upstream backend_servers {
    server backend1.example.com;
    server backend2.example.com;
    server backend3.example.com;

    # если сервер не отвечает на 3 запроса подряд, он временно не используется
    server backend1.example.com max_fails=3 fail_timeout=30s;
}
Вывод
Используйте upstream для указания серверов-бэкэндов.
Настраивайте различные алгоритмы балансировки в зависимости от требований: Round Robin для равномерного распределения, Least Connections для наименьшего числа соединений, IP Hash для привязки клиентов к одному серверу.
Настраивайте параметры весов и проверок доступности для более гибкого управления нагрузкой.





