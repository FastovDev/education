Настройка Nginx как прокси-сервера для сложного backend подразумевает маршрутизацию запросов к различным сервисам backend, балансировку нагрузки и обработку ошибок.

### Основные шаги настройки:

#### 1. **Установка Nginx**

Убедитесь, что Nginx установлен. Например, на Ubuntu:

`sudo apt update sudo apt install nginx`

#### 2. **Общая структура конфигурации**

Конфигурация прокси-сервера в Nginx выглядит следующим образом:


`http {     upstream backend_app1 {         server 127.0.0.1:8001;         server 127.0.0.1:8002;     }      upstream backend_app2 {         server 127.0.0.1:9001;         server 127.0.0.1:9002;     }      server {         listen 80;         server_name example.com;          location /api/app1/ {             proxy_pass http://backend_app1/;             proxy_set_header Host $host;             proxy_set_header X-Real-IP $remote_addr;             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;             proxy_set_header X-Forwarded-Proto $scheme;         }          location /api/app2/ {             proxy_pass http://backend_app2/;             proxy_set_header Host $host;             proxy_set_header X-Real-IP $remote_addr;             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;             proxy_set_header X-Forwarded-Proto $scheme;         }          error_page 502 503 504 /custom_50x.html;         location = /custom_50x.html {             root /usr/share/nginx/html;         }     } }`

#### 3. **Подробное описание конфигурации**

1. **Upstream-блоки**:
    
    - Группируют backend-сервера.
    - Используются для балансировки нагрузки между ними.
    
    `upstream backend_app1 {     server 127.0.0.1:8001;     server 127.0.0.1:8002; }`
    
2. **Proxy Pass**:
    
    - Перенаправляет запросы с Nginx на backend.
    - Пример: запросы на `/api/app1/` направляются на `backend_app1`.
    
    
    `proxy_pass http://backend_app1/;`
    
3. **Заголовки (Headers)**:
    
    - Передача информации от клиента к backend-серверам.
    - Установка заголовков позволяет backend видеть реальный IP клиента, протокол и хост.
    
       
    `proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;`
    
4. **Обработка ошибок**:
    
    - Создается пользовательская страница для ошибок `502`, `503`, `504`.
    
    
    `error_page 502 503 504 /custom_50x.html; location = /custom_50x.html {     root /usr/share/nginx/html; }`
    

---

#### 4. **Дополнительные настройки**

1. **Кэширование ответов от backend**: Если backend возвращает повторяющиеся ответы, кэширование уменьшает нагрузку:
    
     
    `location /api/app1/ {     proxy_pass http://backend_app1/;     proxy_cache my_cache;     proxy_cache_valid 200 1h;     proxy_cache_key $uri$is_args$args; }`
    
    - Кэш конфигурируется в блоке `http`:
        
         `proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m inactive=60m;`
        
2. **Балансировка нагрузки**: По умолчанию используется метод **round-robin**. Вы можете переключиться на другие методы:
    
    - **Least Connections** (минимальное число соединений):
        
        
        `upstream backend_app1 {     least_conn;     server 127.0.0.1:8001;     server 127.0.0.1:8002; }`
        
    - **IP Hash** (закрепление клиента за одним сервером):
        
          `upstream backend_app1 {     ip_hash;     server 127.0.0.1:8001;     server 127.0.0.1:8002; }`
        
3. **Поддержка WebSocket**: Для приложений с WebSocket добавьте:
    `location /ws/ {     proxy_pass http://backend_app1/;     proxy_set_header Upgrade $http_upgrade;     proxy_set_header Connection "upgrade"; }`
    
4. **HTTPS**: Если вы хотите настроить SSL:
    `server {     listen 443 ssl;     server_name example.com;      ssl_certificate /etc/ssl/certs/example.com.crt;     ssl_certificate_key /etc/ssl/private/example.com.key;      location / {         proxy_pass http://backend_app1/;         proxy_set_header Host $host;         proxy_set_header X-Real-IP $remote_addr;     } }`
    
5. **Лимит соединений**: Для предотвращения перегрузки backend:
    `limit_req_zone $binary_remote_addr zone=api_limit:10m rate=5r/s; location /api/ {     limit_req zone=api_limit burst=10;     proxy_pass http://backend_app1/; }`
    

#### 5. **Перезапуск Nginx**

После внесения изменений:

1. Проверьте конфигурацию:
    `sudo nginx -t`
    
2. Перезапустите Nginx:
    `sudo systemctl reload nginx`
    


Эта конфигурация обеспечивает маршрутизацию, балансировку нагрузки, кэширование и безопасное подключение к вашему backend, что делает Nginx мощным инструментом для сложных систем.