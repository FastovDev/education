**SSH (Secure Shell)** — это криптографический сетевой протокол, используемый для безопасного управления удаленными серверами, выполнения команд, передачи файлов и туннелирования. SSH обеспечивает шифрование и аутентификацию, защищая данные от перехвата и атак.

SSH делится на клиентскую (SSH Client), используемый для подключения к серверу, использует команду ssh и соответствующий процесс и серверную часть (SSH Server), отвечающую за принятие входящих соединений, sshd процесс. 

SSH может применятся для управления удаленным сервером, передачи данных, туннелирования, создания VPN. SSH обеспечивает хорошую скорость работы и низкое потребление ресурсов, несколько уровней защиты и проверку данных, что обеспечивает надежность и безопасность. 
### Основные функции SSH

1. **Управление удаленными системами** (позволяет администратору подключаться к серверу, запускать команды и управлять конфигурацией)
2. **Безопасная передача файлов** (используются инструменты на базе SSH, такие как `scp` и `rsync`, для копирования файлов между машинами)
3. **Туннелирование и пересылка портов** (позволяет создавать зашифрованные туннели для передачи данных между клиентом и сервером).
4. **Переадресация X11** (для запуска графических приложений с удаленного сервера на локальной машине).

### Как работает SSH?

Когда клиент подключается к серверу происходят следующие действия:

1. **Установление соединения** (клиент открывает TCP (Transmission Control Protocol)-соединение с сервером на порту `22`). Данный порт используется по умолчанию, но порт может быть другим, если указан в команде подключения или в настройках сервера. Соединение обеспечивается за счет трехэтапного рукопожатия. Сначала по открытому TCP соединению посылается запрос синхронизации SYN, отправляемый на сервер. Сервер отвечает SYN-ACK запросом, подтверждая возможность синхронизации и сообщая что он готов к соединению. Клиент отправляет в ответ ACK запрос, подтверждая, что он тоже готов к соединению. 
2. **Криптографический Handshake** (клиент и сервер обмениваются ключами, чтобы согласовать параметры шифрования). 
3. **Аутентификация** (клиент аутентифицируется с помощью либо пароля, что менее безопасно, либо с помощью ключевой пары, что более надежно)
4. **Передача данных** (после успешной аутентификации данные передаются через зашифрованный канал).

### Основные команды SSH

1. **Подключение к серверу**:
        
    `ssh user@host`
    
    - `user` — имя пользователя на сервере.
    - `host` — IP-адрес или доменное имя.
2. **Передача файлов**:
    
    - С использованием `scp`:
        
        
        `scp local_file user@host:/remote/path`
        
3. **Туннелирование**:
    
    - Перенаправление порта:
        
        `ssh -L local_port:destination_host:destination_port user@host`
        
    - Пример: доступ к базе данных на сервере через локальный порт:
        
        
        `ssh -L 5432:localhost:5432 user@host`
        
4. **Проверка подключения**:
    
    - Добавьте флаг `-v` для детальной информации:
        
        
        `ssh -v user@host`
        

### Расширенные возможности SSH

1. **Конфигурация через `~/.ssh/config`**: Упростите подключение с помощью конфигурационного файла:
    
    
    `Host myserver     HostName example.com     User username     Port 2222     IdentityFile ~/.ssh/id_rsa`
    
    Теперь можно подключаться проще:
    
    `ssh myserver`
    
2. **Обратное туннелирование**:
    
    - Используется для доступа к локальным сервисам через удалённый сервер.
    
    `ssh -R remote_port:localhost:local_port user@remote_host`
    
3. **Переадресация SSH-агента**:
    
    - Для передачи аутентификации через промежуточные серверы:
    
    
    `ssh -A user@intermediate_host`
    

---

### Примеры использования

1. **Удалённое управление сервером**:
    
    
    `ssh admin@192.168.1.100`
    
2. **Копирование директории на сервер**:
    
    
    `scp -r ./project admin@192.168.1.100:/var/www`
    
3. **Создание зашифрованного туннеля для доступа к веб-приложению**:
    
    
    `ssh -L 8080:localhost:80 admin@192.168.1.100`
    

### Этапы установления SSH-соединения

#### 2. **Инициализация SSH-протокола**

- **Протокол**: SSH Transport Layer Protocol
- **Процесс**:
    - Клиент и сервер обмениваются баннерами (объявлениями) своих версий SSH.
        - Например:
            
            Копировать код
            
            `SSH-2.0-OpenSSH_8.2p1`
            
    - Сервер сообщает о поддерживаемых алгоритмах шифрования, хэширования, и сжатия в формате KEXINIT (Key Exchange Initialization).

---

#### 3. **Согласование параметров криптографии**

- **Протокол**: SSH Key Exchange (KEX)
- **Процесс**:
    1. Клиент и сервер выбирают алгоритмы:
        - **Алгоритм шифрования** (например, AES).
        - **Алгоритм хэширования** (например, SHA-256).
        - **Метод обмена ключами** (например, Diffie-Hellman или Curve25519).
    2. Стороны договариваются о методах аутентификации и сжатия.
    3. После выбора криптографических алгоритмов начинается процесс обмена ключами.

---

#### 4. **Обмен ключами (Key Exchange)**

- **Протокол**: Диффи-Хеллман (или аналогичный)
- **Процесс**:
    - Клиент и сервер обмениваются открытыми параметрами ключей:
        - Сервер отправляет свой публичный ключ.
        - Клиент генерирует сеансовый ключ (session key) и зашифровывает его с помощью публичного ключа сервера.
    - После этого обе стороны используют параметры для генерации симметричного ключа, который будет использоваться для шифрования данных.
    - В результате все дальнейшие данные передаются через зашифрованный канал.

---

#### 5. **Проверка подлинности сервера**

- **Протокол**: Digital Signature Algorithm (DSA) или другой метод подписи.
- **Процесс**:
    - Сервер подписывает свои данные приватным ключом, предоставляя клиенту возможность проверить их подлинность с помощью публичного ключа.
    - Если ключ сервера совпадает с ранее сохранённым (в файле `~/.ssh/known_hosts`), соединение продолжается.
    - Если ключ сервера новый, клиент запросит подтверждение для продолжения.

---

#### 6. **Аутентификация клиента**

- **Протокол**: SSH Authentication Protocol
- **Процесс**: Клиент должен подтвердить свою личность. Существуют два основных метода:
    1. **Парольная аутентификация**:
        - Клиент отправляет зашифрованный пароль на сервер.
        - Сервер проверяет пароль и подтверждает или отказывает в доступе.
    2. **Аутентификация с помощью ключевой пары** (рекомендуется):
        - Клиент подписывает сообщение своим приватным ключом.
        - Сервер проверяет подпись с помощью публичного ключа, сохранённого в файле `~/.ssh/authorized_keys`.

---

#### 7. **Установление защищённого соединения**

- После успешной аутентификации:
    1. Генерируется и используется симметричный ключ для шифрования дальнейших данных.
    2. Данные передаются через защищённый канал.
    3. Все команды, передаваемые клиентом, шифруются и передаются серверу.

---

### Пример последовательности пакетов

1. **TCP Three-Way Handshake**:
    - Клиент: `SYN` → Сервер: `SYN-ACK` → Клиент: `ACK`.
2. **SSH Version Exchange**:
    - Клиент: `SSH-2.0-OpenSSH_8.2` → Сервер: `SSH-2.0-OpenSSH_8.2`.
3. **Key Exchange**:
    - Сервер: Отправляет параметры для KEX (алгоритмы, ключи).
    - Клиент: Генерирует сеансовый ключ, зашифровывает и отправляет серверу.
4. **Server Authentication**:
    - Сервер: Отправляет свою цифровую подпись.
    - Клиент: Проверяет её подлинность.
5. **Client Authentication**:
    - Клиент: Отправляет пароль или подписанное сообщение.
    - Сервер: Проверяет клиента.
6. **Начало защищённого соединения**:
    - Клиент и сервер начинают обмен шифрованными данными.
