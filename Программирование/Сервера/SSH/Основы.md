**SSH (Secure Shell)** — это криптографический сетевой протокол, используемый для безопасного управления удаленными серверами, выполнения команд, передачи файлов и туннелирования. SSH обеспечивает шифрование и аутентификацию, защищая данные от перехвата и атак.

SSH делится на клиентскую (SSH Client), используемый для подключения к серверу, использует команду ssh и соответствующий процесс и серверную часть (SSH Server), отвечающую за принятие входящих соединений, sshd процесс. 

SSH может применятся для управления удаленным сервером, передачи данных, туннелирования, создания VPN. SSH обеспечивает хорошую скорость работы и низкое потребление ресурсов, несколько уровней защиты и проверку данных, что обеспечивает надежность и безопасность. 
### Основные функции SSH

1. **Управление удаленными системами** (позволяет администратору подключаться к серверу, запускать команды и управлять конфигурацией)
2. **Безопасная передача файлов** (используются инструменты на базе SSH, такие как `scp` и `rsync`, для копирования файлов между машинами)
3. **Туннелирование и пересылка портов** (позволяет создавать зашифрованные туннели для передачи данных между клиентом и сервером).
4. **Переадресация X11** (для запуска графических приложений с удаленного сервера на локальной машине).

### Как работает SSH?

Когда клиент подключается к серверу происходят следующие действия:

1. **Установление соединения** (клиент открывает TCP (Transmission Control Protocol)-соединение с сервером на порту `22`). Данный порт используется по умолчанию, но порт может быть другим, если указан в команде подключения или в настройках сервера. Соединение обеспечивается за счет трехэтапного рукопожатия. Сначала по открытому TCP соединению посылается запрос синхронизации SYN, отправляемый на сервер. Сервер отвечает SYN-ACK запросом, подтверждая возможность синхронизации и сообщая что он готов к соединению. Клиент отправляет в ответ ACK запрос, подтверждая, что он тоже готов к соединению. 
2. Клиент и сервер пытаются установить соединение на уровне SSH (Transport Layer Protocol). На этом этапе клиент и сервер обмениваются своими версиями SSH. Сервер сообщает клиенту о поддерживаемых алгоритмах шифрования, хэширования и сжатия в формате KEXINIT (Key Exchange Initialization)
3. **Криптографический Handshake** (клиент и сервер обмениваются ключами, чтобы согласовать параметры шифрования).  Используется протокол SSH Key Exchange (KEX), клиент и сервер в процессе выбирают алгоритм шифрования, алгоритм хэширования, метод обмена ключами, договариваются о методах аутентификации и сжатия. Часть настроек этих параметров берется из файлов конфигурации, часть берется из подаваемой команды подключения со стороны клиента. После выбора криптографических алгоритмов начинается процесс обмена ключами. 
4. **Аутентификация** (клиент аутентифицируется с помощью либо пароля, что менее безопасно, либо с помощью ключевой пары, что более надежно). Более подробную информацию об этой части подключения смотреть в заметке аутентификация.  Если к серверу ни разу с указанными ключами не подключались, то поступит запрос на подтверждение для продолжения к подключению. Информация сохранится в файле `~/.ssh/known_hosts`. 
5. **Передача данных** (после успешной аутентификации данные передаются через зашифрованный канал). В процессе работы этого этапа генерируется симметричный ключ для шифрования данных. 
### Пример последовательности пакетов

1. **TCP Three-Way Handshake**:
    - Клиент: `SYN` → Сервер: `SYN-ACK` → Клиент: `ACK`.
2. **SSH Version Exchange**:
    - Клиент: `SSH-2.0-OpenSSH_8.2` → Сервер: `SSH-2.0-OpenSSH_8.2`.
3. **Key Exchange**:
    - Сервер: Отправляет параметры для KEX (алгоритмы, ключи).
    - Клиент: Генерирует сеансовый ключ, зашифровывает и отправляет серверу.
4. **Server Authentication**:
    - Сервер: Отправляет свою цифровую подпись.
    - Клиент: Проверяет её подлинность.
5. **Client Authentication**:
    - Клиент: Отправляет пароль или подписанное сообщение.
    - Сервер: Проверяет клиента.
6. **Начало защищённого соединения**:
    - Клиент и сервер начинают обмен шифрованными данными.

### Основные команды SSH

**Подключение к серверу**: `ssh user@host`
Детальный вывод информации:  `ssh -v user@host`

Полный вывод команд можно найти в заметке - Флаги SSH.
### Расширенные возможности SSH

**Конфигурация через `~/.ssh/config`**:  подключение с помощью конфигурационного файла:
`Host myserver     HostName example.com     User username     Port 2222     IdentityFile ~/.ssh/id_rsa`

Теперь можно подключаться проще:  `ssh myserver`

**Переадресация SSH-агента** для передачи аутентификации через промежуточные серверы:
`ssh -A user@intermediate_host`
