API Gateway — это паттерн, который служит входной точкой для всех клиентских запросов к микросервисной архитектуре. Он позволяет централизованно управлять маршрутизацией, аутентификацией, агрегацией данных и другими аспектами взаимодействия между клиентами и внутренними сервисами. В ASP.NET Core для реализации API Gateway активно используются такие решения, как **Ocelot** и **YARP**.

---

## 1. Основные концепции

- **Централизация входящего трафика:** API Gateway принимает все запросы от клиентов и распределяет их между микросервисами.
- **Маршрутизация и агрегация:** Возможность объединять данные из разных сервисов и выдавать единый ответ.
- **Безопасность и аутентификация:** Реализация централизованной проверки аутентификации и авторизации, а также других политик (например, rate limiting).
- **Трансформация запросов/ответов:** Возможность модификации входящих или исходящих сообщений (например, переименование полей, сжатие данных).

---

## 2. Ocelot

### Описание

- **Ocelot** — это популярный API Gateway для .NET Core, созданный специально для микросервисных архитектур.
- Позволяет настраивать маршруты, агрегировать ответы, реализовывать политики безопасности и многое другое через конфигурационные файлы (например, _ocelot.json_).

### Преимущества

- Простота настройки через конфигурационный файл.
- Хорошая интеграция с ASP.NET Core и поддержка множества функциональных возможностей: маршрутизация, аутентификация, rate limiting, кэширование и трансформация запросов.

### Пример конфигурации Ocelot

**ocelot.json:**

```json
{
  "Routes": [
    {
      "DownstreamPathTemplate": "/api/orders/{everything}",
      "DownstreamScheme": "http",
      "DownstreamHostAndPorts": [
        {
          "Host": "localhost",
          "Port": 5001
        }
      ],
      "UpstreamPathTemplate": "/orders/{everything}",
      "UpstreamHttpMethod": [ "GET", "POST", "PUT", "DELETE" ]
    }
  ],
  "GlobalConfiguration": {
    "BaseUrl": "http://localhost:5000"
  }
}
```
**Интеграция в Program.cs (.NET 6+):**

```C#
using Ocelot.DependencyInjection;
using Ocelot.Middleware;

var builder = WebApplication.CreateBuilder(args);

// Добавление Ocelot с загрузкой конфигурации
builder.Configuration.AddJsonFile("ocelot.json", optional: false, reloadOnChange: true);
builder.Services.AddOcelot(builder.Configuration);

var app = builder.Build();

// Подключение Ocelot middleware
await app.UseOcelot();

app.Run();
```
---

## 3. YARP (Yet Another Reverse Proxy)

### Описание

- **YARP** — это высокопроизводительный и гибкий реверс-прокси, разработанный Microsoft на основе ASP.NET Core.
- Он позволяет динамически конфигурировать маршруты и балансировку нагрузки, а также поддерживает расширенные возможности по обработке запросов.

### Преимущества

- Гибкая и расширяемая архитектура, возможность программной настройки маршрутов.
- Высокая производительность, так как построен на современных возможностях ASP.NET Core.
- Поддержка динамических обновлений конфигурации маршрутизации без перезапуска приложения.

### Пример конфигурации YARP

**appsettings.json:**

```json
{
  "ReverseProxy": {
    "Routes": [
      {
        "RouteId": "orders",
        "ClusterId": "ordersCluster",
        "Match": {
          "Path": "/orders/{**catch-all}"
        }
      }
    ],
    "Clusters": {
      "ordersCluster": {
        "Destinations": {
          "ordersDestination": {
            "Address": "http://localhost:5001/api/orders/"
          }
        }
      }
    }
  }
}

```

**Интеграция в Program.cs (.NET 6+):**

```C#
using Yarp.ReverseProxy.Configuration;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddReverseProxy()
    .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));

var app = builder.Build();

app.MapReverseProxy();

app.Run();

```

---

## 4. Сравнительный анализ Ocelot и YARP

|**Параметр**|**Ocelot**|**YARP**|
|---|---|---|
|**Настройка маршрутов**|Конфигурация через JSON-файл (_ocelot.json_), простая настройка.|Конфигурация через appsettings.json или программно, гибкая.|
|**Функциональность**|Встроенная поддержка аутентификации, rate limiting, кэширования.|Высокая производительность, расширяемость, динамическая маршрутизация.|
|**Сложность внедрения**|Легко интегрируется в микросервисную архитектуру на ASP.NET Core.|Требует более тонкой настройки, но предоставляет больше возможностей.|
|**Поддержка**|Широкое сообщество и набор готовых функциональностей.|Разрабатывается Microsoft, ориентирован на масштабируемость и высокую производительность.|

---

## 5. Когда использовать

### Ocelot

- Подходит для проектов, где требуется быстрое и простое решение для маршрутизации запросов.
- Идеален для небольших и средних микросервисных архитектур, где конфигурация через JSON-файл удовлетворяет требованиям.
- Если необходимы дополнительные возможности (аутентификация, rate limiting, кэширование) «из коробки».

### YARP

- Выбор для проектов, где требуется высокая производительность и динамическая настройка маршрутов.
- Подходит для масштабируемых решений, где важна гибкость программного управления маршрутами и балансировкой нагрузки.
- Если необходима интеграция с современными решениями Microsoft и поддержка сложных сценариев маршрутизации.

---

## 6. Заключение

API Gateway является критически важным компонентом в микросервисной архитектуре, позволяющим централизованно управлять входящими запросами, маршрутизацией, аутентификацией и другими аспектами взаимодействия.

- **Ocelot** обеспечивает простоту настройки и богатый функционал для большинства типичных сценариев, предлагая готовые решения для обеспечения безопасности и управления трафиком.
- **YARP** ориентирован на высокую производительность и гибкость, позволяя динамически изменять конфигурацию маршрутов и балансировки нагрузки.

Выбор между Ocelot и YARP зависит от требований конкретного проекта, его масштабируемости и особенностей инфраструктуры. Оба решения интегрируются с ASP.NET Core и позволяют эффективно управлять входящими запросами, обеспечивая надежную работу распределенной системы.