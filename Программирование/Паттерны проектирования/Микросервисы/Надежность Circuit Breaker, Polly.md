Паттерны **Circuit Breaker** и **Retry Policy** направлены на повышение надёжности распределённых систем за счёт устойчивости к временным сбоям внешних зависимостей. Одним из самых популярных инструментов для реализации этих паттернов в .NET является библиотека [Polly](https://github.com/App-vNext/Polly).

---

## 1. Основные принципы

### Circuit Breaker

- **Идея:** «Предохранитель» для защиты системы. Если внешний сервис начинает возвращать ошибки (например, из-за недоступности), Circuit Breaker «размыкает цепь» и предотвращает дальнейшие вызовы, позволяя системе «отдохнуть».
- **Состояния:**
    - **Closed (замкнуто):** запросы проходят нормально, ошибки отслеживаются.
    - **Open (разомкнуто):** при достижении порога ошибок цепь размыкается, и запросы сразу отклоняются без вызова внешнего сервиса.
    - **Half-Open (полуразомкнуто):** после определённого времени система делает несколько тестовых запросов для проверки восстановления зависимости.

### Retry Policy

- **Идея:** Повторная попытка выполнения операции при временных сбоях.
- **Стратегии:**
    - **Фиксированная задержка:** постоянное время ожидания между попытками.
    - **Экспоненциальный backoff:** время ожидания увеличивается с каждой неудачной попыткой, снижая нагрузку на систему.
- **Преимущества:** Позволяет устранить временные сбои, такие как кратковременная недоступность внешнего API или проблемы с сетью.

### Polly

- **Polly** — это библиотека, которая позволяет декларативно задавать политики отказоустойчивости: повторные попытки, Circuit Breaker, fallback, bulkhead isolation и многие другие.
- Благодаря интеграции с ASP.NET Core, Polly легко комбинируется с HttpClientFactory для создания надёжных HTTP-клиентов.

---

## 2. Интеграция с ASP.NET Core

### Использование HttpClientFactory и Polly

В ASP.NET Core можно зарегистрировать HttpClient с включёнными политиками отказоустойчивости. Это позволяет централизованно управлять повторными попытками и механизмом Circuit Breaker для всех исходящих запросов к внешним сервисам.

Пример регистрации в `Program.cs` или `Startup.cs`:

```C#
builder.Services.AddHttpClient("MyExternalServiceClient")
    // Политика повторных попыток с экспоненциальным backoff: 3 попытки с ожиданием 2^retryAttempt секунд
    .AddTransientHttpErrorPolicy(policyBuilder =>
         policyBuilder.WaitAndRetryAsync(3, retryAttempt => 
             TimeSpan.FromSeconds(Math.Pow(2, retryAttempt))))
    // Политика Circuit Breaker: размыкаем цепь после 5 последовательных ошибок на 30 секунд
    .AddTransientHttpErrorPolicy(policyBuilder =>
         policyBuilder.CircuitBreakerAsync(
             handledEventsAllowedBeforeBreaking: 5,
             durationOfBreak: TimeSpan.FromSeconds(30)));

```

### Использование в контроллере

При внедрении зависимостей (DI) можно получить HttpClient по имени и использовать его для вызова внешнего сервиса:

```C#
[ApiController]
[Route("api/[controller]")]
public class WeatherController : ControllerBase
{
    private readonly HttpClient _httpClient;

    public WeatherController(IHttpClientFactory httpClientFactory)
    {
        // Получаем клиент с настроенными политиками
        _httpClient = httpClientFactory.CreateClient("MyExternalServiceClient");
    }

    [HttpGet("forecast")]
    public async Task<IActionResult> GetForecast()
    {
        var response = await _httpClient.GetAsync("https://api.weather.com/forecast");

        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return Ok(content);
        }

        return StatusCode((int)response.StatusCode, "Ошибка при получении данных прогноза");
    }
}

```

---

## 3. Примеры использования и сравнительный анализ

### Пример использования Retry Policy

- **Сценарий:** Внешний API иногда недоступен из-за кратковременных проблем с сетью.
- **Плюсы:** Позволяет автоматически повторить запрос, что зачастую устраняет временную ошибку без вмешательства пользователя.
- **Минусы:** Чрезмерное количество повторов может замедлить обработку, поэтому важно подбирать разумные параметры (количество попыток, задержку).

### Пример использования Circuit Breaker

- **Сценарий:** При длительной недоступности внешнего сервиса повторные попытки только увеличивают нагрузку и ухудшают общую производительность системы.
- **Плюсы:** Отключает вызовы к неработающему сервису, позволяя системе быстрее переключаться на альтернативные сценарии или отдавать информацию об ошибке.
- **Минусы:** Может привести к отказу даже при временных проблемах, если порог ошибок выбран слишком низким.

### Сравнительный анализ

|**Параметр**|**Retry Policy**|**Circuit Breaker**|
|---|---|---|
|**Основная цель**|Автоматически повторять запросы при сбоях|Предотвращать перегрузку системы при длительных сбоях|
|**Подход**|Повторение операции с задержкой|Прерывание цепи вызовов при превышении порога ошибок|
|**Когда применять**|При кратковременных, преходящих сбоях|При наличии устойчивых проблем в внешних сервисах|
|**Преимущества**|Устраняет временные неполадки|Защищает систему от цепной реакции ошибок|
|**Ограничения**|Может замедлить работу при частых сбоях|Неправильная настройка может привести к ложным срабатываниям|

---

## 4. Когда использовать и рекомендации

- **Retry Policy** рекомендуется использовать, когда:
    
    - Внешний сервис может временно возвращать ошибки, и повторная попытка имеет смысл.
    - Ошибки связаны с сетью или кратковременными нагрузками.
    - Важно обеспечить автоматическое восстановление без вмешательства пользователя.
- **Circuit Breaker** рекомендуется применять, когда:
    
    - Существует риск перегрузки системы из-за постоянных сбоев внешнего сервиса.
    - Нужна защита от каскадного эффекта при отказе зависимостей.
    - Требуется быстро переключаться на альтернативные сценарии или сообщать об ошибке, если сервис не восстанавливается.

---

## 5. Заключение

Паттерны **Circuit Breaker** и **Retry Policy** позволяют существенно повысить надёжность и устойчивость распределённых систем. С помощью библиотеки Polly в ASP.NET Core можно легко интегрировать эти паттерны, обеспечивая:

- Автоматическое восстановление при временных сбоях.
- Защиту от перегрузок при длительной недоступности внешних сервисов.
- Централизованное управление политиками отказоустойчивости через HttpClientFactory.

Выбор конкретных параметров (количество повторов, длительность размыкания цепи и т.д.) зависит от особенностей вашего приложения и характера внешних зависимостей. В совокупности данные подходы помогают обеспечить стабильную работу приложения даже при возникновении непредвиденных проблем во внешних сервисах.